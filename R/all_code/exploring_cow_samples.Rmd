

Checking out the cow samples


data split between paired and single strand sequencing

Processed samples are at 
'/grid/gillis/data/hover/work/cmxci1.paired/Bos_taurus'
'/grid/gillis/data/hover/work/cmxci1.single/Bos_taurus'

```{r}
library(ggplot2)
library(ggExtra)
library(stringr)
library(parallel)
library(dplyr)
library(ggridges)
library(MetBrewer)
```



```{r}

processed_files = list.files('/grid/gillis/home/hover/work/cmxci.paired/Bos_taurus')
wasp_vcf_files_paired = processed_files[grepl('.wasp.chrX.snps_filtered.vcf',processed_files  )]
#Ignore the .vcf.idx files
wasp_vcf_files_paired = wasp_vcf_files_paired[!grepl('.idx',wasp_vcf_files_paired )]
wasp_wig_files_paired = processed_files[grepl('.wasp.chrX.split.filtered.wig',processed_files  )]

length(wasp_vcf_files_paired)
length(wasp_wig_files_paired)

head(wasp_vcf_files_paired)
```


```{r}

processed_files = list.files('/grid/gillis/home/hover/work/cmxci.single/Bos_taurus')
wasp_vcf_files_single = processed_files[grepl('.wasp.chrX.snps_filtered.vcf',processed_files  )]
#Ignore the .vcf.idx files
wasp_vcf_files_single = wasp_vcf_files_single[!grepl('.idx',wasp_vcf_files_single )]
wasp_wig_files_single = processed_files[grepl('.wasp.chrX.split.filtered.wig',processed_files  )]

length(wasp_vcf_files_single)
length(wasp_wig_files_single)

head(wasp_vcf_files_single)
```

```{r}
wig_samples = sapply(strsplit(wasp_wig_files_paired, split = '.', fixed = T), '[[', 1)
wig_samples = c(wig_samples, sapply(strsplit(wasp_wig_files_single, split = '.', fixed = T), '[[', 1) ) #Add the single samples 
vcf_samples = sapply(strsplit(wasp_vcf_files_paired, split = '.', fixed = T), '[[', 1)
vcf_samples = c(vcf_samples, sapply(strsplit(wasp_vcf_files_single, split = '.', fixed = T), '[[', 1) )
table(wig_samples == vcf_samples)

```




```{r}


wasp_vcf_files_paired = paste('/grid/gillis/home/hover/work/cmxci.paired/Bos_taurus/',wasp_vcf_files_paired, sep = '')
wasp_vcf_files_single = paste('/grid/gillis/home/hover/work/cmxci.single/Bos_taurus/',wasp_vcf_files_single, sep = '')

wasp_wig_files_paired = paste('/grid/gillis/home/hover/work/cmxci.paired/Bos_taurus/',wasp_wig_files_paired, sep = '')
wasp_wig_files_single = paste('/grid/gillis/home/hover/work/cmxci.single/Bos_taurus/',wasp_wig_files_single, sep = '')


wasp_vcf_files = c(wasp_vcf_files_paired, wasp_vcf_files_single)
wasp_wig_files = c(wasp_wig_files_paired, wasp_wig_files_single)


length(wasp_vcf_files)

```



Function for merging the wig and vcf info, filtering for heterozygous SNPs with 2 alleles and a minimum of 10 reads per allele


```{r}
source('get_exp_vcf.R')
```


```{r}
Sys.time()
wasp_filt_vcf = mclapply(1:length(wasp_vcf_files), function(i) get_exp_vcf(vcf_file_path = wasp_vcf_files[i], 
                                                                           wig_file_path = wasp_wig_files[i]), mc.cores = 5)
Sys.time()

```


```{r}

head(wasp_filt_vcf)


```


Number of filtered SNPs kept
```{r}

num_snps = vector(mode = 'numeric', length = length(wasp_filt_vcf))

for(i in 1:length(wasp_filt_vcf)){
  data = wasp_filt_vcf[[i]]
  
  if(is.null(dim(data))){
    num_snps[i] = 0
  }else{num_snps[i] = dim(data)[1]}
}

hist(num_snps, breaks = seq(0,max(num_snps), 2))


```


```{r}
table(num_snps >= 300)

high_snp_index = which(num_snps >= 300)

for(i in high_snp_index){
  
  data = wasp_filt_vcf[[i]]
  tot_counts = data$ref_counts + data$alt_counts
  ref_ratios = data$ref_counts / tot_counts
  
  hist(ref_ratios, breaks = seq(0,1,.01))
  
}



```

Get the gene specific distributions


Getting the genome annotations
Genomes are currently located on Elzar at /grid/gillis/data_norepl/hover/genomes
Copied over a few to rugen18

```{r}


cow_gtf = rtracklayer::import('/home/werner/projects/cross_species_XCI/genomes/Bos_taurus/annotation.gtf')
cow_gtf = as.data.frame(cow_gtf)

#Genome specific x chromosome name
cow_x_chrom_name = readLines('/home/werner/projects/cross_species_XCI/genomes/Bos_taurus/chrXlabel.txt', n = 1)

cow_x_gtf = cow_gtf[cow_gtf$seqnames == cow_x_chrom_name, ]

cow_x_genenames = unique(cow_x_gtf$gene)
length(cow_x_genenames)
```


Adding gene annotations to each sample


```{r}
cow_x_meta = cow_x_gtf[cow_x_gtf$gbkey == 'Gene',]
x_gene_starts = cow_x_meta$start
x_gene_ends = cow_x_meta$end


annot_cow_vcfs = wasp_filt_vcf

for(j in 1:length(annot_cow_vcfs)){
  test = annot_cow_vcfs[[j]]
  if(is.null(dim(test))){next}
  
  
  gene_annots = vector(mode = 'character', length = length(test$Pos))
  gene_biotype = vector(mode = 'character', length = length(test$Pos))
  for( i in 1:dim(test)[1]){
  
    test_gene_start = test$Pos[i]
    gene_index = findInterval(test_gene_start, x_gene_starts)
    if(gene_index == 0){next}
    
    if(test_gene_start <= x_gene_ends[gene_index]){
      
      gene_annots[i] = cow_x_meta$gene[gene_index]
      gene_biotype[i] = cow_x_meta$gene_biotype[gene_index]
    }
  }
  
  test$gene = gene_annots
  test$gene_biotype = gene_biotype
  annot_cow_vcfs[[j]] = test
}

head(annot_cow_vcfs)

```


save the annotated vcfs with all the SNPs present


```{r}
save(annot_cow_vcfs, file = '/home/werner/projects/cross_species_XCI/data/species_data_analysis/bos_taurus/all_snp_vcf_3_15_23.Rdata')


```

```{r}
load('/home/werner/projects/cross_species_XCI/data/species_data_analysis/bos_taurus/all_snp_vcf_3_15_23.Rdata')

```


```{r}
annot_cow_vcfs[1:5]

```

Looking at global distribution of reference ratios versus read counts for all SNPs
```{r}
all_total_counts = c()
all_ref_ratios = c()

for(i in 1:length(annot_cow_vcfs)){

  data = annot_cow_vcfs[[i]]
  if(is.null(dim(data))){next}
  total_counts = data$ref_counts + data$alt_counts
  ref_ratios = data$ref_counts / total_counts
  
  all_total_counts = c(all_total_counts, total_counts)
  all_ref_ratios = c(all_ref_ratios, ref_ratios)

}

length(all_total_counts)


plot(all_ref_ratios, log10(all_total_counts), cex = .5)


```



Looking at gene specific expression 


```{r}

captured_genes = c()
for( i in 1:length(annot_cow_vcfs)){
  suppressWarnings(if(is.null(dim(annot_cow_vcfs[[i]]))){next})
  captured_genes = c(captured_genes, annot_cow_vcfs[[i]]$gene)
}

captured_genes = unique(captured_genes)
captured_genes = captured_genes[captured_genes != ""]

length(captured_genes)
```


```{r}
for(i in 1:100){
  
  current_gene = captured_genes[i]
  
  gene_ref_exp = c()
  for(j in 1:length(annot_cow_vcfs)){
    suppressWarnings(if(is.null(dim(annot_cow_vcfs[[j]]))){next})
    gene_index = annot_cow_vcfs[[j]]$gene == current_gene
    ref_counts = annot_cow_vcfs[[j]]$ref_counts[gene_index]
    alt_counts = annot_cow_vcfs[[j]]$alt_counts[gene_index]
    total_counts = ref_counts + alt_counts
    gene_ref_exp = c(gene_ref_exp, ref_counts / total_counts )

  }
  
  
  hist(gene_ref_exp, main = current_gene, xlim = c(0,1), breaks = seq(0,1, .025))  
  
}

```



Checking SNP specific ratio distributions, seems to be only certain SNPs that are causing problems

```{r}

captured_SNPs = c()
for( i in 1:length(annot_cow_vcfs)){
  suppressWarnings(if(is.null(dim(annot_cow_vcfs[[i]]))){next})
  captured_SNPs = c(captured_SNPs, annot_cow_vcfs[[i]]$Pos)
}

captured_SNPs = unique(captured_SNPs)
captured_SNPs = captured_SNPs[captured_SNPs != ""]

length(captured_SNPs)
```
Grab the mean read counts and variance in read counts as well

```{r}

snp_stat_df = data.frame(snp_pos = integer(length(captured_SNPs)), num_samples_present = integer(length(captured_SNPs)), 
                         mean_ref_ratio = integer(length(captured_SNPs)), mean_total_counts = integer(length(captured_SNPs)), sd_total_counts = integer(length(captured_SNPs)))

for(i in 1:length(captured_SNPs)){

  if(i %% 1000 == 0){print(i)}
  current_SNP = captured_SNPs[i]
  
  snp_ref_exp = c()
  snp_total_reads = c()
  for(j in 1:length(annot_cow_vcfs)){
    suppressWarnings(if(is.null(dim(annot_cow_vcfs[[j]]))){next})
    gene_index = annot_cow_vcfs[[j]]$Pos == current_SNP
    ref_counts = annot_cow_vcfs[[j]]$ref_counts[gene_index]
    alt_counts = annot_cow_vcfs[[j]]$alt_counts[gene_index]
    total_counts = ref_counts + alt_counts
    snp_ref_exp = c(snp_ref_exp, ref_counts / total_counts )
    snp_total_reads = c(snp_total_reads, total_counts)
    
    
  }
  
  snp_stat_df$snp_pos[i] = current_SNP
  snp_stat_df$num_samples_present[i] = length(snp_ref_exp)
  snp_stat_df$mean_ref_ratio[i] = mean(snp_ref_exp)
  snp_stat_df$mean_total_counts[i] = mean(snp_total_reads)
  snp_stat_df$sd_total_counts[i] = sd(snp_total_reads)
}

```


```{r}
hist(snp_stat_df$mean_ref_ratio, breaks = seq(0,1,.01), xlab = 'Mean reference ratio per SNP', main = 'Bos taurus')
hist(snp_stat_df$num_samples_present)
par(pty = 's')
plot(snp_stat_df$mean_ref_ratio,snp_stat_df$num_samples_present, cex = .25, xlab = 'Mean reference ratio', 
     ylab = '# of samples SNP is detected', main = 'Bos taurus Het SNPs')
abline(v = .5, col = 'red')
abline(h = 2100, col = 'blue')
abline(v = .4, col = 'blue')
abline(v = .6, col = 'blue')
```


```{r}

plot(snp_stat_df$mean_total_counts, snp_stat_df$sd_total_counts, cex = .5)

```


Filter out SNPs present in at least 20 samples that have a mean reference ratio < .4 or > .6, 
Should get rid of SNPs with consistent reference bias without excluding whole genes



```{r}

snp_stat_df$filter = !(snp_stat_df$mean_ref_ratio < .4 | snp_stat_df$mean_ref_ratio > .6)
table(snp_stat_df$filter)

```


Save the SNP dataframe

```{r}

save(snp_stat_df, file = '/home/werner/projects/cross_species_XCI/data/species_data_analysis/bos_taurus/detected_het_snps_df_3_15_23.Rdata')

cow_snp_stat_df = snp_stat_df
save(cow_snp_stat_df, file = '/home/werner/projects/cross_species_XCI/final_plots/R/data_for_plots/cow_snp_stat_df.Rdata')

```

```{r}
load('/home/werner/projects/cross_species_XCI/data/species_data_analysis/bos_taurus/detected_het_snps_df_3_15_23.Rdata')

```

```{r}
snp_stat_df

```

plot for supplemental figures of SNP filtering

```{r}

library(gridExtra)

p1 = ggplot(snp_stat_df, aes(x = mean_ref_ratio)) + geom_histogram(binwidth = .025, color = 'black', fill = 'grey') + 
  xlab(' ') + ylab('Number of SNPs') + ggtitle('Bos taurus') +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), aspect.ratio = 1, 
      panel.background = element_rect(fill = 'white'), panel.border = element_rect(color = "black", fill=NA),  
      axis.text.y = element_text(size=12), axis.text.x = element_text(size=12),
      axis.title.y = element_text(size=12), axis.title.x = element_text(size=12)) 

p2 = ggplot(snp_stat_df, aes(x = mean_ref_ratio, y = num_samples_present)) + geom_point(alpha = .5, size = 1) + 
  geom_vline(xintercept = c(.4, .6), color = 'blue') + geom_vline(xintercept = .5, color = 'red') +
  xlab('Mean reference ratio') + ylab('Number of samples SNP is detected') +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), aspect.ratio = 1, 
    panel.background = element_rect(fill = 'white'), panel.border = element_rect(color = "black", fill=NA),  
    axis.text.y = element_text(size=12), axis.text.x = element_text(size=12),
    axis.title.y = element_text(size=12), axis.title.x = element_text(size=12))

p3 = grid.arrange(p1, p2, ncol = 1)

#ggsave(plot = p3, filename = 'cow_x_ref_snp_filtering_plots.pdf', path = '/home/werner/projects/cross_species_XCI/code/graphs/ref_snp_filtering/', device = 'pdf',
#       useDingbats = F, width = 5, height = 8)

```




Filtering the vcfs for only annotated genes and the max powered SNP per gene


```{r}
filt_cow_vcfs = annot_cow_vcfs

for(i in 1:length(filt_cow_vcfs)){
  test = filt_cow_vcfs[[i]]
  
  suppressWarnings(if(is.null(dim(test))){next})
  
  #Get rid of SNPs in nonannotated genes
  test = test[test$gene != "", ]
  suppressWarnings(if(dim(test)[1] == 0){filt_cow_vcfs[[i]] = NA; next})

  #Get the unique number of genes
  sample_genes = unique(test$gene)
  test_2 = data.frame(matrix(NA, 
                             nrow = length(sample_genes), 
                             ncol = dim(test)[2]))
  colnames(test_2) = colnames(test)
  
  
  for(j in 1:length(sample_genes)){
    
    current_gene_data = test[test$gene == sample_genes[j], ]
    if(dim(current_gene_data)[1] == 1){
      test_2[j, ] = current_gene_data
    }else{
      
      current_tot_exp = current_gene_data$ref_counts + current_gene_data$alt_counts
      test_2[j, ] = current_gene_data[which.max(current_tot_exp), ]
    }
  }

  filt_cow_vcfs[[i]] = test_2
}

```


save the filtered vcf list

```{r}
save(filt_cow_vcfs, file = '/home/werner/projects/cross_species_XCI/data/species_data_analysis/bos_taurus/max_snp_vcf_3_15_23.Rdata')


```

```{r}
load('/home/werner/projects/cross_species_XCI/data/species_data_analysis/bos_taurus/max_snp_vcf_3_15_23.Rdata')

```


```{r}

filt_cow_vcfs[1:5]

```



Number of genes per samples


```{r}

num_filt_genes = vector(mode = 'numeric', length = length(filt_cow_vcfs))
for(i in 1:length(filt_cow_vcfs)){
  
  suppressWarnings(if(is.null(dim(filt_cow_vcfs[[i]]))){
    num_filt_genes[i] = 0
    next
    
  })
  
  num_filt_genes[i] = dim(filt_cow_vcfs[[i]])[1]

}



```

```{r}



hist(num_filt_genes, breaks = seq(0,300,2))

sum(num_filt_genes >= 10)
```

look at the SNP distributions, with and without including the potentially reference biased SNPs

```{r}

index_num_samps = which(num_filt_genes >= 30)


index = seq(200,300,1)

for(i in index){

  data = filt_cow_vcfs[[index_num_samps[i]]]
  
  snp_filter = data$Pos %in% snp_stat_df$snp_pos[snp_stat_df$filter]
  
  
  total_exp = data$ref_counts + data$alt_counts
  ref_ratios = data$ref_counts[snp_filter] / total_exp[snp_filter]
  
  #ref_ratios = data$ref_counts / total_exp
  
  hist(ref_ratios, xlim = c(0,1), breaks = seq(0,1, .01))
  abline(v = .5, col = 'red')

}
```


Skew modeling

```{r}


# Functions to fold and unfold ratios 
folded <- function(x) { apply( cbind(x,1-x), 1, max)} 
unfold <- function(x) { c(x,1-x) } 

#Sara's MLE function
# Maximum likelihood estimate function. Note, x is a global variable! Should fix but this lets me use it in the bootstrap later.  
mle_folded <- function(x){ 
  mus = seq(0.5,1, by = 0.001)
  sigmas = seq(0,0.5, by = 0.01)
  
  mles = sapply(mus, function(mu)
    sapply(sigmas, function(sigma)
      -sum( log(dnorm( x,   mean = mu, sd = sigma )
                + dnorm( x,   mean = 1-mu, sd = sigma ) )  )))
  mles[!is.finite(mles)] = NA
  coefs = which(mles==min(mles, na.rm=T), arr.ind=T)
  return (list( mus[coefs[2]] , sigmas[coefs[1]]))
} 

```




```{r}
Ns = vector(mode='numeric', length = length(filt_cow_vcfs))

for(i in 1:length(filt_cow_vcfs)){
  
  suppressWarnings(if(is.null(dim(filt_cow_vcfs[[i]]))){Ns[i] = 0}
  else{Ns[i] = dim(filt_cow_vcfs[[i]])[1]})
  
}

```

```{r}

ratios.max = list()
for(i in 1: length(filt_cow_vcfs)){
  
  if(Ns[i] == 0){next}
  
  total_exp = filt_cow_vcfs[[i]]$ref_counts + filt_cow_vcfs[[i]]$alt_counts
  ref_ratios = filt_cow_vcfs[[i]]$ref_counts / total_exp
  ratios.max[[i]] = ref_ratios

}

head(ratios.max)

```


```{r}

est_skew_func = function(list.skew.max, Ns, ratios.max, snp_stat_df, filter_snps = T){
  
  #If there's only 1 or 0 SNPs, don't estimate a skew
  if(Ns <= 0){return(NA)}
  
  #Filter for the good snps
  if(filter_snps){
    snp_index = list.skew.max$Pos %in% snp_stat_df$snp_pos[snp_stat_df$filter]
    #Fold the reference skews
    folded_ref_skews = folded(ratios.max[snp_index])
  }else{
    folded_ref_skews = folded(ratios.max)
  }
  #return the mean and sigma estimates
  return(mle_folded(folded_ref_skews))
}

```


```{r}

Sys.time()
folded_norm_fits = mclapply(1:length(filt_cow_vcfs), function(i) est_skew_func(filt_cow_vcfs[[i]], Ns[i], ratios.max[[i]], snp_stat_df), mc.cores = 20)
Sys.time()


Sys.time()
folded_norm_fits_bad_snps = mclapply(1:length(filt_cow_vcfs), function(i) est_skew_func(filt_cow_vcfs[[i]], Ns[i], ratios.max[[i]], snp_stat_df, filter_snps = F), mc.cores = 20)
Sys.time()

#Grab the skew and variance estimates
est_skew = vector(mode = 'numeric', length = length(folded_norm_fits))
est_var = vector(mode = 'numeric', length = length(folded_norm_fits))
for(i in 1:length(folded_norm_fits)){
  
  if(is.na(folded_norm_fits[i])){
    est_skew[i] = NA
    est_var[i] = NA
    next
  }
  
  est_skew[i] = folded_norm_fits[[i]][[1]]
  est_var[i] = folded_norm_fits[[i]][[2]]
}

#Grab the skew and variance estimates
est_skew_bad_snps = vector(mode = 'numeric', length = length(folded_norm_fits_bad_snps))
est_var_bad_snps = vector(mode = 'numeric', length = length(folded_norm_fits_bad_snps))
for(i in 1:length(folded_norm_fits_bad_snps)){
  
  if(is.na(folded_norm_fits_bad_snps[i])){
    est_skew_bad_snps[i] = NA
    est_var_bad_snps[i] = NA
    next
  }
  
  est_skew_bad_snps[i] = folded_norm_fits_bad_snps[[i]][[1]]
  est_var_bad_snps[i] = folded_norm_fits_bad_snps[[i]][[2]]
}

```


```{r}

hist(est_skew, main = 'Cow skew estimates filtering out bad SNPs', breaks=64)
hist(est_var, main = 'Variance estimates', breaks = 32)
plot(est_skew, est_var)

```

```{r}
par(pty = 's')
plot(est_skew, est_skew_bad_snps, cex = .5)
abline(a = 0, b = 1, col = 'red')
```



Make a dataframe from with the estimated skew stats

```{r}

num_good_snps = vector(length = length(filt_cow_vcfs), mode = 'numeric')
total_snps = vector(length = length(filt_cow_vcfs), mode = 'numeric')

for(i in 1:length(filt_cow_vcfs)){
  
  data = filt_cow_vcfs[[i]]
  suppressWarnings(if(is.null(dim(data))){num_good_snps[i] = 0; total_snps[i] = 0; next})
  
  snp_filter = data$Pos %in% snp_stat_df$snp_pos[snp_stat_df$filter]
  
  total_snps[i] = length(data$Pos)
  num_good_snps[i] = length(data$Pos[snp_filter])
}

plot(total_snps, num_good_snps)

```









```{r}
plot(est_skew, num_good_snps)

```





###########################################
Instead of a per gene approach for identifying escape genes, trying a chromosome binning approach
Using just the skewed samples, get the average reference ratio for all SNPs within a bin and check the distribution. Think on a threshold and then exclude any bins that exhibit balanced biallelic expression. Null distribution should be centered around the skew threshold
###########################################


```{r}
bin_width = 1e6 #1MB bins

#cow
#Use the reference biased SNPs too, more powered to find bins that have balanced biallelic expression in opposition to skew and reference bias
all_ref_ratios = c()
all_snp_pos = c()
cow_het_index = which(est_skew >= .7)
for(i in 1:length(cow_het_index)){

  data = annot_cow_vcfs[[cow_het_index[i]]]
  if(is.null(dim(data))){next}
  #data = data[data$Pos %in% snp_stat_df$snp_pos[snp_stat_df$filter], ]
  ref_ratios = data$ref_counts /(data$ref_counts + data$alt_counts)
  
  all_ref_ratios = c(all_ref_ratios, ref_ratios)
  all_snp_pos = c(all_snp_pos, data$Pos)
  
}

bins = seq(0,max(all_snp_pos), bin_width)
mean_bin_ref_ratio = sapply(1:(length(bins) - 1), function(i) mean(folded(all_ref_ratios[all_snp_pos >= bins[i] & all_snp_pos < bins[i+1]])))
num_snps_bin = sapply(1:(length(bins) - 1), function(i) sum(all_snp_pos >= bins[i] & all_snp_pos < bins[i+1]) )
binned_chrom_df = data.frame(bin = bins[1:(length(bins)-1)], mean_bin_ref_ratio = mean_bin_ref_ratio, num_snps = num_snps_bin)
p1 = ggplot(binned_chrom_df, aes(x = bin, y = mean_bin_ref_ratio, size = num_snps)) + geom_point(alpha = .5) + geom_hline(yintercept = .7, color = 'red') +
  ylab('Mean folded SNP ratio per bin') + xlab('X chromosome position (1MB bins)') + ggtitle('cow All SNPs')+ ylim(.5, 1)
ggMarginal(p1, margins = 'y', type = 'histogram', yparams = list(binwidth = .005))


#Excluding the last 7MB as likely pseudo-autosomal regions
#And excluding 1MB bins with a mean reference ratio below .65
bad_cow_bins = which(mean_bin_ref_ratio<= .65)
bad_cow_bins = c( bad_cow_bins, c(134, 135, 136, 137, 138, 139, 140))
bad_cow_bins = unique(bad_cow_bins)


binned_chrom_df$keep_label = rep('Kept 1MB bin', length = nrow(binned_chrom_df))
binned_chrom_df$keep_label[(binned_chrom_df$bin/1e6) %in% (bad_cow_bins - 1)] = 'Excluded 1MB bin'
p1 = ggplot(binned_chrom_df, aes(x = bin, y = mean_bin_ref_ratio, size = num_snps, color = keep_label)) + geom_point(alpha = .5) + geom_hline(yintercept = .65, color = 'red') +
  ylab('Mean folded SNP ratio per bin') + xlab('X chromosome position (1MB bins)') + ggtitle('cow All SNPs')+ ylim(.5, 1) +
  scale_color_manual(values = c('Kept 1MB bin' = 'black', 'Excluded 1MB bin' = 'red'))  
ggMarginal(p1, margins = 'y', type = 'histogram', yparams = list(binwidth = .005))
#ggsave(filename = 'cow_binnedMB_escape_scatter.pdf', path = '/home/werner/projects/cross_species_XCI/code/graphs/escape/', device = 'pdf', 
#       useDingbats = F, height = 4, width = 6)

cow_binned_chrom_df = binned_chrom_df
save(cow_binned_chrom_df, file = '/home/werner/projects/cross_species_XCI/final_plots/R/data_for_plots/cow_binned_chrom_df.Rdata')
```


```{r}

#Filter out any SNPs that land within these bins
bad_cow_coordinates = unlist(lapply(1:length(bad_cow_bins), function(i) ((bad_cow_bins - 1)*1e6)[i]:((bad_cow_bins)*1e6)[i]))

```


################################
Get skew estimates excluding these bad chromosome bins

################################


save the vcfs without the bad bins

```{r}

filter_bad_bins = function(data){
  if(is.null(dim(data))){return(NA)}
  else{
    escape_index = data$Pos %in% bad_cow_coordinates
    data = data[!escape_index, ]
    return(data)
  }
}

filt_cow_vcfs_noBadbins = mclapply(filt_cow_vcfs, filter_bad_bins, mc.cores = 10)
save(filt_cow_vcfs_noBadbins, file = '/home/werner/projects/cross_species_XCI/data/species_data_analysis/bos_taurus/max_snp_vcf_binFilt_4_27_23.Rdata')
```


```{r}

load('/home/werner/projects/cross_species_XCI/data/species_data_analysis/bos_taurus/max_snp_vcf_binFilt_4_27_23.Rdata')

num_snp_good_bins = vector(mode = 'numeric', length = length(filt_cow_vcfs_noBadbins))
for(i in 1:length(filt_cow_vcfs_noBadbins)){
  
  data = filt_cow_vcfs_noBadbins[[i]]
  if(is.null(dim(data))){num_snp_good_bins[i] = 0}
  else{
    data = data[data$Pos %in% snp_stat_df$snp_pos[snp_stat_df$filter], ]
    num_snp_good_bins[i] = nrow(data)}
}
  
hist(num_snp_good_bins)

sum(num_snp_good_bins >= 10)
```



```{r}
Ns.escape = vector(mode='numeric', length = length(filt_cow_vcfs_noBadbins))

for(i in 1:length(filt_cow_vcfs_noBadbins)){
  
  suppressWarnings(if(is.null(dim(filt_cow_vcfs_noBadbins[[i]]))){Ns.escape[i] = 0}
  else{Ns.escape[i] = dim(filt_cow_vcfs_noBadbins[[i]])[1]})
  
}

```

```{r}

ratios.escape.max = list()
for(i in 1: length(filt_cow_vcfs_noBadbins)){
  
  if(Ns.escape[i] == 0){next}
  
  total_exp = filt_cow_vcfs_noBadbins[[i]]$ref_counts + filt_cow_vcfs_noBadbins[[i]]$alt_counts
  ref_ratios = filt_cow_vcfs_noBadbins[[i]]$ref_counts / total_exp
  ratios.escape.max[[i]] = ref_ratios

}

head(ratios.escape.max)

```


```{r}

Sys.time()
folded_norm_fits_no_escape = mclapply(1:length(filt_cow_vcfs_noBadbins), function(i) 
  est_skew_func(filt_cow_vcfs_noBadbins[[i]], Ns.escape[i], ratios.escape.max[[i]], snp_stat_df), mc.cores = 20)
Sys.time()

#Grab the skew and variance estimates
est_skew_no_escape = vector(mode = 'numeric', length = length(folded_norm_fits_no_escape))
est_var_no_escape = vector(mode = 'numeric', length = length(folded_norm_fits_no_escape))
for(i in 1:length(folded_norm_fits)){
  
  if(is.na(folded_norm_fits_no_escape[i])){
    est_skew_no_escape[i] = NA
    est_var_no_escape[i] = NA
    next
  }
  
  est_skew_no_escape[i] = folded_norm_fits_no_escape[[i]][[1]]
  est_var_no_escape[i] = folded_norm_fits_no_escape[[i]][[2]]
}


```


check all samples

```{r}

sample_index = which(num_snp_good_bins >= 10)
length(sample_index)
for(i in 1001:1350){
  
  data = filt_cow_vcfs_noBadbins[[sample_index[i]]]
  data = data[data$Pos %in% snp_stat_df$snp_pos[snp_stat_df$filter], ]
  ref_ratios = data$ref_counts / (data$ref_counts + data$alt_counts)
  hist(ref_ratios, breaks = seq(0,1,.025), main = sprintf('sample %i skew: %0.3f', sample_index[i], est_skew_no_escape[sample_index[i]]))

}

```

potentially reference biased samples

c(199, 220, 363, 364, 365, 366, 622, 626, 637,638, 652, 1137, 1147, 1149 , 1277:1288  )

#########################################
Looking for a measure of reference bias at the sample level
Use the escape bins. If a sample is reference biased, then would it's escape expression also be reference biased? 

use the full annot_cow_vcf to look across all snps in the sample

#########################################

```{r}


escape_mean = rep(NA, length = length(annot_cow_vcfs))
escape_var = rep(NA, length = length(annot_cow_vcfs))
num_escape_snps = rep(NA, length = length(annot_cow_vcfs))
inact_mean = rep(NA, length = length(annot_cow_vcfs))
inact_var = rep(NA, length = length(annot_cow_vcfs))
num_inact_snps = rep(NA, length = length(annot_cow_vcfs))

for(i in 1:length(annot_cow_vcfs)){

  data = annot_cow_vcfs[[i]]
  if(is.null(dim(data))){next}
  escape_index = (plyr::round_any(data$Pos, 1000000, ceiling)/1e6) %in% bad_cow_bins #Get the SNPs located in the escape bins
  ref_ratios = data$ref_counts / (data$ref_counts + data$alt_counts)
  escape_ref_ratios = ref_ratios[escape_index]
  ref_ratios = ref_ratios[!escape_index]
  
  escape_mean[i] = mean(folded(escape_ref_ratios) - .5)
  escape_var[i] = var(folded(escape_ref_ratios) - .5)
  num_escape_snps[i] = sum(escape_index)
  inact_mean[i] = mean(folded(ref_ratios) - .5)
  inact_var[i] = var(folded(ref_ratios) - .5)
  num_inact_snps[i] = sum(!escape_index)

}

hist(escape_mean, breaks = seq(0,.5, .01))
hist(inact_mean, breaks = seq(0,.5, .01))
hist(escape_var, breaks = seq(0,.1, .001))
hist(inact_var, breaks = seq(0,.1, .001))

snp_filter = num_inact_snps >= 10 | num_escape_snps >= 10
par(pty = 's')
plot(inact_mean[snp_filter], escape_mean[snp_filter], cex = .5)
abline(a = 0, b = 1, col = 'red')

plot(inact_var[snp_filter], escape_var[snp_filter], cex = .5)
abline(a = 0, b = 1, col = 'red')

hist(inact_mean[inact_mean >= .15] - escape_mean[inact_mean >= .15], breaks = 40)

maybe_ref_biased = which(inact_mean >= .15  & (inact_mean - escape_mean) >= -.05  & (inact_mean - escape_mean) <= .05 )
all_ref_biased_inact = c()
all_ref_biased_escape = c()
all_norm_inact = c()
all_norm_escape = c()
for(i in 1:length(filt_cow_vcfs_noBadbins)){

  data = annot_cow_vcfs[[i]]
  if(is.null(dim(data))){next}
  data = data[data$Pos %in% snp_stat_df$snp_pos[snp_stat_df$filter], ]
  escape_index = (plyr::round_any(data$Pos, 1000000, ceiling)/1e6) %in% bad_cow_bins #Get the SNPs located in the escape bins
  ref_ratios = data$ref_counts / (data$ref_counts + data$alt_counts)
  escape_ref_ratios = ref_ratios[escape_index]
  ref_ratios = ref_ratios[!escape_index]

  if(i %in% maybe_ref_biased){
    all_ref_biased_inact = c(all_ref_biased_inact, ref_ratios)
    all_ref_biased_escape = c(all_ref_biased_escape, escape_ref_ratios)
  }else{
    all_norm_inact = c(all_norm_inact, ref_ratios)
    all_norm_escape = c(all_norm_escape, escape_ref_ratios)
  }
}


all_ratios = c(c(folded(all_ref_biased_inact), folded(all_ref_biased_escape)), c(folded(all_norm_inact), folded(all_norm_escape)))

escape_label = c(c(rep('inactivated', length = length(all_ref_biased_inact)), rep('escape', length = length(all_ref_biased_escape))),
c(rep('inactivated', length = length(all_norm_inact)), rep('escape', length = length(all_norm_escape))))

reference_label = c(rep('reference_biased', length = length(c(all_ref_biased_inact, all_ref_biased_escape))), 
rep('non-reference_biased', length = length(c(all_norm_inact, all_norm_escape))))


testing_reference_df = data.frame(folded_ratios = all_ratios, escape_label = escape_label, reference_label = reference_label)

ggplot(testing_reference_df, aes(x = reference_label, y = folded_ratios, fill = escape_label)) + geom_violin()

```






```{r}

sample_index = which(num_snp_good_bins >= 10)

hist(unfold(est_skew_no_escape[sample_index]), breaks = seq(0,1,.01))

```


```{r}
par(pty = 's')
plot(est_skew, est_skew_no_escape, xlim = c(.5, 1), ylim = c(.5, 1))
abline(a = 0, b = 1, col = 'red')

plot(est_skew_no_escape, num_snp_good_bins, xlim = c(.5, 1))
abline(h = 10, col = 'red')


```



```{r}

chrX_skewed_index = which(est_skew_no_escape >= .7 & num_snp_good_bins >= 10)

all_chrX_skewed_snps = c()
for(i in 1:length(chrX_skewed_index)){
  
  data = filt_cow_vcfs_noBadbins[[chrX_skewed_index[i]]]
  data = data[data$Pos %in% snp_stat_df$snp_pos[snp_stat_df$filter], ]
  ref_ratios = data$ref_counts / (data$ref_counts + data$alt_counts)
  hist(ref_ratios, breaks = seq(0,1,.025), main = sprintf('Sample index: %i est skew: %0.3f',chrX_skewed_index[i], est_skew_no_escape[chrX_skewed_index[i]]))
  all_chrX_skewed_snps = c(all_chrX_skewed_snps, ref_ratios)
  
}

hist(all_chrX_skewed_snps, breaks = seq(0,1,.025), main = 'All compiled SNPs')


chrX_Nonskewed_index = which(est_skew_no_escape < .7 & num_snp_good_bins >= 10)

all_chrX_Nonskewed_snps = c()
for(i in 1:length(chrX_Nonskewed_index)){
  
  data = filt_cow_vcfs_noBadbins[[chrX_Nonskewed_index[i]]]
  data = data[data$Pos %in% snp_stat_df$snp_pos[snp_stat_df$filter], ]
  ref_ratios = data$ref_counts / (data$ref_counts + data$alt_counts)
  all_chrX_Nonskewed_snps = c(all_chrX_Nonskewed_snps, ref_ratios)
  
}

hist(all_chrX_Nonskewed_snps, breaks = seq(0,1,.025), main = 'All compiled SNPs')

```

```{r}

species_colors = met.brewer("Tiepolo", n=10,type="continuous")

enoughSNPs_index = which(num_snp_good_bins >= 10)

all_ref_ratios = c()
all_skews = c()
for(i in 1:length(enoughSNPs_index)){
  
  data = filt_cow_vcfs_noBadbins[[enoughSNPs_index[i]]]
  data = data[data$Pos %in% snp_stat_df$snp_pos[snp_stat_df$filter], ]
  ref_ratios = data$ref_counts / (data$ref_counts + data$alt_counts)
  all_ref_ratios = c(all_ref_ratios, ref_ratios)
  all_skews = c(all_skews, rep(est_skew_no_escape[enoughSNPs_index[i]], length = length(ref_ratios)))
  
}


skew_bin_snp_df = data.frame(ref_ratios = all_ref_ratios, est_skew_no_escape = all_skews)
skew_bin_snp_df$bin_label = rep('0.50 <= XCI ratio < 0.55', length = nrow(skew_bin_snp_df))
skew_bin_snp_df$bin_label[skew_bin_snp_df$est_skew_no_escape >= .55 & skew_bin_snp_df$est_skew_no_escape < 0.60] = '0.55 <= XCI ratio < 0.60'
skew_bin_snp_df$bin_label[skew_bin_snp_df$est_skew_no_escape >= .60 & skew_bin_snp_df$est_skew_no_escape < 0.65] = '0.60 <= XCI ratio < 0.65'
skew_bin_snp_df$bin_label[skew_bin_snp_df$est_skew_no_escape >= .65 & skew_bin_snp_df$est_skew_no_escape < 0.70] = '0.65 <= XCI ratio < 0.70'
skew_bin_snp_df$bin_label[skew_bin_snp_df$est_skew_no_escape >= .70 & skew_bin_snp_df$est_skew_no_escape < 0.75] = '0.70 <= XCI ratio < 0.75'
skew_bin_snp_df$bin_label[skew_bin_snp_df$est_skew_no_escape >= .75 & skew_bin_snp_df$est_skew_no_escape < 0.80] = '0.75 <= XCI ratio < 0.80'
skew_bin_snp_df$bin_label[skew_bin_snp_df$est_skew_no_escape >= .80 & skew_bin_snp_df$est_skew_no_escape < 0.85] = '0.80 <= XCI ratio < 0.85'
skew_bin_snp_df$bin_label[skew_bin_snp_df$est_skew_no_escape >= .85 & skew_bin_snp_df$est_skew_no_escape < 0.90] = '0.85 <= XCI ratio < 0.90'
skew_bin_snp_df$bin_label[skew_bin_snp_df$est_skew_no_escape >= .90 & skew_bin_snp_df$est_skew_no_escape < 0.95] = '0.90 <= XCI ratio < 0.95'
skew_bin_snp_df


ggplot(skew_bin_snp_df, aes(x = ref_ratios, y = bin_label)) + geom_density_ridges(rel_min_height = 0.01, scale = 0.95, fill = species_colors[9] ) + xlim(0,1) +
  scale_y_discrete(limits=rev) + ylab('Binned sample XCI ratio') + xlab('Unfolded SNP reference expression ratios') + ggtitle('Bos taurus')
#ggsave(filename = 'cow_chrX_skew_binned_refRatio_ridgePlot.pdf', path = '/home/werner/projects/cross_species_XCI/code/graphs/species_skew_binned_refRatios/', 
#       device = 'pdf', useDingbats = F, height = 6, width = 6)

cow_skew_bin_snp_df = skew_bin_snp_df
save(cow_skew_bin_snp_df, file = '/home/werner/projects/cross_species_XCI/final_plots/R/data_for_plots/cow_skew_bin_snp_df.Rdata')
```



```{r}
cow_skew_and_stats_df = data.frame(sample_id = wig_samples, 
                                   est_skew = est_skew, est_var = est_var,  #Skew estimates filtering out bad genes
                                   est_skew_total_snps = est_skew_bad_snps, est_var_total_snps = est_var_bad_snps,   #Skew estimates with all genes 
                                   est_skew_no_escape = est_skew_no_escape, est_var_no_escape = est_var_no_escape,   #Skew estimates filtering out escape
                                   num_good_snps = num_good_snps, total_snps = total_snps, num_good_snps_no_escape = num_snp_good_bins)

cow_skew_and_stats_df
```


```{r}

save(cow_skew_and_stats_df, file = '/home/werner/projects/cross_species_XCI/data/species_data_analysis/bos_taurus/cow_skew_and_stats_binFilt_df_4_27_23.Rdata')

```




Check the binned chromosome expression again
```{r}
bin_width = 1e6 #1MB bins

#cow
#Use the reference biased SNPs too, more powered to find bins that have balanced biallelic expression in opposition to skew and reference bias
all_ref_ratios = c()
all_snp_pos = c()
cow_het_index = which(est_skew_no_escape >= .7)
for(i in 1:length(cow_het_index)){

  data = filt_cow_vcfs_noBadbins[[cow_het_index[i]]]
  if(is.null(dim(data))){next}
  #data = data[data$Pos %in% snp_stat_df$snp_pos[snp_stat_df$filter], ]
  ref_ratios = data$ref_counts /(data$ref_counts + data$alt_counts)
  
  all_ref_ratios = c(all_ref_ratios, ref_ratios)
  all_snp_pos = c(all_snp_pos, data$Pos)
  
}

bins = seq(0,max(all_snp_pos), bin_width)
mean_bin_ref_ratio = sapply(1:(length(bins) - 1), function(i) mean(folded(all_ref_ratios[all_snp_pos >= bins[i] & all_snp_pos < bins[i+1]])))
num_snps_bin = sapply(1:(length(bins) - 1), function(i) sum(all_snp_pos >= bins[i] & all_snp_pos < bins[i+1]) )
binned_chrom_df = data.frame(bin = bins[1:(length(bins)-1)], mean_bin_ref_ratio = mean_bin_ref_ratio, num_snps = num_snps_bin)
p1 = ggplot(binned_chrom_df, aes(x = bin, y = mean_bin_ref_ratio, size = num_snps)) + geom_point(alpha = .5) + geom_hline(yintercept = .7, color = 'red') +
  ylab('Mean folded SNP ratio per bin') + xlab('X chromosome position (1MB bins)') + ggtitle('cow All SNPs')+ ylim(.5, 1)
ggMarginal(p1, margins = 'y', type = 'histogram', yparams = list(binwidth = .005))


```













######################################
Trying to find escape genes

######################################


```{r}

all_genes = c()

for(i in 1:length(filt_cow_vcfs)){
  if(is.null(dim(filt_cow_vcfs[[i]]))){next}
  all_genes = c(all_genes,filt_cow_vcfs[[i]]$gene )
}

all_genes = unique(all_genes)
length(all_genes)

```

Get a p-value per sample for gene's deviation from .5 in skewed samples. Small p-value is balanced biallelic expression in skewed samples
Fishers method to combine p values over all the samples

```{r}

gene_thresh = 20

gene_chi_right_p_values = vector(mode = 'numeric', length = length(all_genes))
names(gene_chi_right_p_values) = all_genes
gene_chi_left_p_values = vector(mode = 'numeric', length = length(all_genes))
names(gene_chi_left_p_values) = all_genes
num_pvalues =  vector(mode = 'numeric', length = length(all_genes))
skewed_index = which(est_skew_bad_snps >= .6)

for(j in 1:length(all_genes)){

  p_value_vec = c()
  num_genes_vec = c()
  for(i in 1:length(skewed_index)){
  
    if(is.null(dim(filt_cow_vcfs[[skewed_index[i]]]))){next}
    
    data = filt_cow_vcfs[[skewed_index[i]]]
    #data = data[data$Pos %in% snp_stat_df$snp_pos[snp_stat_df$filter], ]
    
    if(!all_genes[j] %in% data$gene){next}
    
    gene_index = data$gene == all_genes[j]
    ratios = data$ref_counts / (data$ref_counts + data$alt_counts)
    deviations = abs(ratios - .5)
    gene_deviation = deviations[gene_index]
    deviations = deviations[!gene_index]
    p_value = sum(deviations <= gene_deviation) / (length(deviations)+1)
    num_genes = length(deviations)
    p_value_vec = c(p_value_vec, p_value)
    num_genes_vec = c(num_genes_vec, num_genes)
  
  }
  
  if(length(p_value_vec) == 0){next}
  p_value_vec[p_value_vec == 0] = 1e-5
  #hist(p_value_vec[num_genes_vec >= gene_thresh], breaks = seq(0,1,.025), main = all_genes[j])
  
  #Get the Fishers method p-value for this gene
  chi_stat = -2 * sum(log(p_value_vec[num_genes_vec >= gene_thresh]))
  gene_chi_right_p_values[j] = pchisq(chi_stat, 2*sum(num_genes_vec >= gene_thresh), lower.tail = F)
  gene_chi_left_p_values[j] = pchisq(chi_stat, 2*sum(num_genes_vec >= gene_thresh), lower.tail = T)
  num_pvalues[j] = sum(num_genes_vec >= gene_thresh)
     
}

```

```{r}

adj_gene_chi_right_p_values = p.adjust(gene_chi_right_p_values, method = 'BH')
adj_gene_chi_left_p_values = p.adjust(gene_chi_left_p_values, method = 'BH')


hist(adj_gene_chi_right_p_values, breaks = seq(0,1,.025))
hist(adj_gene_chi_right_p_values[num_pvalues >= gene_thresh], breaks = seq(0,1,.025))

escape_gene_index = which(adj_gene_chi_right_p_values <= .001 & num_pvalues >= gene_thresh)
adj_gene_chi_right_p_values[escape_gene_index]
all_genes[escape_gene_index]


```
```{r}

adj_gene_chi_left_p_values = p.adjust(gene_chi_left_p_values, method = 'BH')
adj_gene_chi_left_p_values = p.adjust(gene_chi_left_p_values, method = 'BH')


hist(adj_gene_chi_left_p_values, breaks = seq(0,1,.025))
hist(adj_gene_chi_left_p_values[num_pvalues >= gene_thresh], breaks = seq(0,1,.025))

imprint_gene_index = which(adj_gene_chi_left_p_values <= .001 & num_pvalues >=gene_thresh)
adj_gene_chi_left_p_values[imprint_gene_index]
all_genes[imprint_gene_index]


```
p-value distributions of genes called as escape

```{r}

skewed_index = which(est_skew_bad_snps >= .6)

for(j in 1:length(all_genes[escape_gene_index])){

  gene = all_genes[escape_gene_index][j]
  
  p_value_vec = c()
  num_genes_vec = c()
  for(i in 1:length(skewed_index)){
  
    if(is.null(dim(filt_cow_vcfs[[skewed_index[i]]]))){next}
    
    data = filt_cow_vcfs[[skewed_index[i]]]
    #data = data[data$Pos %in% snp_stat_df$snp_pos[snp_stat_df$filter], ]
    
    if(!gene %in% data$gene){next}
    
    gene_index = data$gene == gene
    ratios = data$ref_counts / (data$ref_counts + data$alt_counts)
    deviations = abs(ratios - .5)
    gene_deviation = deviations[gene_index]
    deviations = deviations[!gene_index]
    p_value = sum(deviations <= gene_deviation) / length(deviations)
    num_genes = length(deviations)
    p_value_vec = c(p_value_vec, p_value)
    num_genes_vec = c(num_genes_vec, num_genes)
  
  }
  
  p_value_vec[p_value_vec == 0] = 1e-5
  hist(p_value_vec[num_genes_vec >= gene_thresh], breaks = seq(0,1,.025), main =gene)
  
    
     
}

```



p-value distributions of genes preferentially always highly skewed
```{r}

skewed_index = which(est_skew_bad_snps >=  .6)

for(j in 1:length(all_genes[imprint_gene_index])){

  gene = all_genes[imprint_gene_index][j]
  
  p_value_vec = c()
  num_genes_vec = c()
  for(i in 1:length(skewed_index)){
  
    if(is.null(dim(filt_cow_vcfs[[skewed_index[i]]]))){next}
    
    data = filt_cow_vcfs[[skewed_index[i]]]
    #data = data[data$Pos %in% snp_stat_df$snp_pos[snp_stat_df$filter], ]
    
    if(!gene %in% data$gene){next}
    
    gene_index = data$gene == gene
    ratios = data$ref_counts / (data$ref_counts + data$alt_counts)
    deviations = abs(ratios - .5)
    gene_deviation = deviations[gene_index]
    deviations = deviations[!gene_index]
    p_value = sum(deviations <= gene_deviation) / length(deviations)
    num_genes = length(deviations)
    p_value_vec = c(p_value_vec, p_value)
    num_genes_vec = c(num_genes_vec, num_genes)
  
  }
  
  p_value_vec[p_value_vec == 0] = 1e-5
  hist(p_value_vec[num_genes_vec >= gene_thresh], breaks = seq(0,1,.025), main =gene)
  
    
     
}

```


check out escape tails in the most skewed samples
```{r}

escape_genes = all_genes[adj_gene_chi_right_p_values <= .001 & num_pvalues >=gene_thresh]

sample_index = which(est_skew >= .6)

for(j in 1:length(escape_genes)){

  current_esp_gene = escape_genes[j]
  escp_gene_ratios = c()
  
  for(i in 1:length(sample_index)){
    
    data = filt_cow_vcfs[[sample_index[i]]]
    data = data[data$Pos %in% snp_stat_df$snp_pos[snp_stat_df$filter], ]
    esc_gene_index = data$gene == current_esp_gene
    ratios = data$ref_counts / (data$ref_counts + data$alt_counts)
    
    escp_gene_ratios = c(escp_gene_ratios, ratios[esc_gene_index])
    
  }
  
  hist(escp_gene_ratios, breaks = seq(0,1,.025), main = current_esp_gene)
}


```


```{r}

escape_genes = all_genes[escape_gene_index]


sample_index = which(total_snps >= 10 & est_skew_bad_snps >= .6)
all_escape_ratios = c()
all_non_ratios  = c()
for(i in 1:length(sample_index)){
  
  data = filt_cow_vcfs[[sample_index[i]]]
  data = data[data$Pos %in% snp_stat_df$snp_pos[snp_stat_df$filter], ]
  
  ref_ratios = data$ref_counts/ (data$ref_counts + data$alt_counts)
  escape_index = data$gene %in% escape_genes
  
  escape_ratios = ref_ratios[escape_index]
  nonescape_ratios = ref_ratios[!escape_index]
  #hist(nonescape_ratios, breaks = seq(0,1,.025))
  #hist(escape_ratios, add = T, col = 'red', breaks = seq(0,1,.025))
  all_escape_ratios = c(all_escape_ratios, escape_ratios)
  all_non_ratios  = c(all_non_ratios , nonescape_ratios)
  
}


hist(all_non_ratios, breaks = seq(0,1,.025))
hist(all_escape_ratios, add = T, col = 'red', breaks = seq(0,1,.025))

```







look at the expression levels of the SNPs from the escape genes and the imprint genes


```{r}
snp_stat_df

escape_genes = all_genes[adj_gene_chi_right_p_values <= .001 & num_pvalues >=gene_thresh]
imprint_genes = all_genes[adj_gene_chi_left_p_values <= .001 & num_pvalues >=gene_thresh]

escape_pos = c()
imprint_pos = c()
for(i in 1:length(filt_cow_vcfs)){
  if(is.null(dim(filt_cow_vcfs[[skewed_index[i]]]))){next}
  data = filt_cow_vcfs[[skewed_index[i]]]
  escape_pos = c(escape_pos, data$Pos[data$gene %in% escape_genes])
  imprint_pos = c(imprint_pos, data$Pos[data$gene %in% imprint_genes])

}

escape_pos = unique(escape_pos)
imprint_pos = unique(imprint_pos)

temp_snp_exp_df = snp_stat_df[ ,c('snp_pos','mean_total_counts')]
temp_snp_exp_df$label = rep('regular', length = nrow(temp_snp_exp_df))
temp_snp_exp_df$label[temp_snp_exp_df$snp_pos %in% escape_pos] = 'escape'
temp_snp_exp_df$label[temp_snp_exp_df$snp_pos %in% imprint_pos] = 'imprint'
table(temp_snp_exp_df$label)

temp_snp_exp_df$label = factor(temp_snp_exp_df$label, levels = c('regular','escape','imprint'))
ggplot(temp_snp_exp_df, aes(x = label, y = log10(mean_total_counts), color = label)) + geom_violin(scale = 'width', color = 'black') + geom_boxplot(width = .5) +
  scale_color_manual(values = c('regular' = 'darkgreen', 'escape' = 'red', 'imprint' = 'blue'))


```


pull together a dataframe of the escape stats per gene to save 

```{r}

escape_label = rep('non-escape', length = length(all_genes))
escape_label[adj_gene_chi_right_p_values <= .001 & num_pvalues >=gene_thresh] = 'escape'
escape_cow_df = data.frame(gene = all_genes, num_pvalues = num_pvalues,
                           chi_right_p_values = gene_chi_right_p_values, chi_left_p_values = gene_chi_left_p_values,
                           adj_chi_right_p_values = adj_gene_chi_right_p_values, adj_chi_left_p_values = adj_gene_chi_left_p_values,
                           escape_label = escape_label)

escape_cow_df

save(escape_cow_df, file = '/home/werner/projects/cross_species_XCI/data/species_data_analysis/bos_taurus/escape_cow_df_3_15_23.Rdata')



```

```{r}



load('/home/werner/projects/cross_species_XCI/data/species_data_analysis/bos_taurus/escape_cow_df.Rdata')
cow_escape = escape_cow_df$gene[escape_cow_df$escape_label == 'escape']

conserved_escape = intersect(cow_escape, sheep_escape)


escape_cow_df




```



##############################################
look at the chromosomal position of the escape genes
##############################################


```{r}
#same gene metadata as before
cow_x_meta = cow_x_gtf[cow_x_gtf$gbkey == 'Gene'& !is.na(cow_x_gtf$gbkey),]
x_gene_starts = cow_x_meta$start
x_gene_ends = cow_x_meta$end


escape_genes = escape_cow_df$gene[escape_cow_df$escape_label == 'escape']

#Get the mean expression of each gene. Take the mean of the mean total counts of the SNPs within that gene
gene_name_vec = vector(mode = 'character', length = nrow(snp_stat_df))
for(i in 1:nrow(snp_stat_df)){
  gene_index = findInterval(snp_stat_df$snp_pos[i], cow_x_meta$start)
  if(gene_index == 0){gene_name_vec[i] = NA; next}
  
  if(snp_stat_df$snp_pos[i] <= cow_x_meta$end[gene_index]){
    gene_name_vec[i] = cow_x_meta$gene[gene_index]
  }else{gene_name_vec[i] = NA}
}

#Add gene names to the snp stat df
snp_stat_df$gene = gene_name_vec
#Ignore SNPs not in annotated genes
temp_snp_stat_df = snp_stat_df[!is.na(snp_stat_df$gene), ]
mean_gene_df = temp_snp_stat_df %>% group_by(gene) %>% summarize(mean_exp = mean(mean_total_counts), num_snps = length(mean_total_counts))
mean_gene_df

gene_pos_df = data.frame(gene_name = cow_x_meta$gene, gene_start = cow_x_meta$start, gene_end = cow_x_meta$end, 
                         gene_biotype = cow_x_meta$gene_biotype, escape_label = cow_x_meta$gene %in% escape_genes)

index = match(gene_pos_df$gene_name, mean_gene_df$gene)
gene_pos_df$mean_exp = mean_gene_df$mean_exp[index]
gene_pos_df$num_snps = mean_gene_df$num_snps[index]

gene_pos_df

ggplot(gene_pos_df, aes(x = gene_start, y = log10(mean_exp), color = escape_label)) + geom_point(aes(size = escape_label)) +
  scale_color_manual(values = c('TRUE' = 'red', 'FALSE' = 'black')) +
  scale_size_manual(values = c('TRUE' = 2, 'FALSE' = 1))
ggplot(gene_pos_df, aes(x = gene_start, y = log10(num_snps), color = escape_label)) + geom_point(aes(size = escape_label)) +
  scale_color_manual(values = c('TRUE' = 'red', 'FALSE' = 'black')) +
  scale_size_manual(values = c('TRUE' = 2, 'FALSE' = 1))
```


################################
Get skew estimates excluding these potential escape genes

################################


save the vcfs without the escape genes

```{r}
filt_cow_vcfs_noEscape = filt_cow_vcfs
num_snp_escape = vector(mode = 'numeric', length = length(filt_cow_vcfs_noEscape))
for(i in 1:length(filt_cow_vcfs_noEscape)){
  
  if(is.null(dim(filt_cow_vcfs_noEscape[[i]]))){next}
  escape_index = filt_cow_vcfs_noEscape[[i]]$gene %in% escape_genes
  filt_cow_vcfs_noEscape[[i]] = filt_cow_vcfs_noEscape[[i]][!escape_index, ]
  num_snp_escape[i] = dim(filt_cow_vcfs_noEscape[[i]])
}


```


```{r}

save(filt_cow_vcfs_noEscape, file = '/home/werner/projects/cross_species_XCI/data/species_data_analysis/bos_taurus/max_snp_vcf_noEscape_3_15_23.Rdata')

```

```{r}
load(file = '/home/werner/projects/cross_species_XCI/data/species_data_analysis/bos_taurus/max_snp_vcf_noEscape.Rdata')
filt_cow_vcfs_noEscape[1:5]
```


```{r}
Ns.escape = vector(mode='numeric', length = length(filt_cow_vcfs_noEscape))

for(i in 1:length(filt_cow_vcfs_noEscape)){
  
  suppressWarnings(if(is.null(dim(filt_cow_vcfs_noEscape[[i]]))){Ns.escape[i] = 0}
  else{Ns.escape[i] = dim(filt_cow_vcfs_noEscape[[i]])[1]})
  
}

```

```{r}

ratios.escape.max = list()
for(i in 1: length(filt_cow_vcfs_noEscape)){
  
  if(Ns.escape[i] == 0){next}
  
  total_exp = filt_cow_vcfs_noEscape[[i]]$ref_counts + filt_cow_vcfs_noEscape[[i]]$alt_counts
  ref_ratios = filt_cow_vcfs_noEscape[[i]]$ref_counts / total_exp
  ratios.escape.max[[i]] = ref_ratios

}

head(ratios.escape.max)

```


```{r}

Sys.time()
folded_norm_fits_no_escape = mclapply(1:length(filt_cow_vcfs_noEscape), function(i) 
  est_skew_func(filt_cow_vcfs_noEscape[[i]], Ns.escape[i], ratios.escape.max[[i]], snp_stat_df), mc.cores = 20)
Sys.time()

#Grab the skew and variance estimates
est_skew_no_escape = vector(mode = 'numeric', length = length(folded_norm_fits_no_escape))
est_var_no_escape = vector(mode = 'numeric', length = length(folded_norm_fits_no_escape))
for(i in 1:length(folded_norm_fits)){
  
  if(is.na(folded_norm_fits_no_escape[i])){
    est_skew_no_escape[i] = NA
    est_var_no_escape[i] = NA
    next
  }
  
  est_skew_no_escape[i] = folded_norm_fits_no_escape[[i]][[1]]
  est_var_no_escape[i] = folded_norm_fits_no_escape[[i]][[2]]
}


```



Compare skew estimates with and without escape

first get the number of SNPs per sample now excluding escape
```{r}

num_good_snps_escape = vector(length = length(filt_cow_vcfs_noEscape), mode = 'numeric')

for(i in 1:length(filt_cow_vcfs_noEscape)){
  
  data = filt_cow_vcfs_noEscape[[i]]
  suppressWarnings(if(is.null(dim(data))){num_good_snps_escape[i] = 0; next})
  
  snp_filter = data$Pos %in% snp_stat_df$snp_pos[snp_stat_df$filter]
  num_good_snps_escape[i] = length(data$Pos[snp_filter])
}

hist(num_good_snps_escape)

```


```{r}
hist(est_skew_no_escape[num_good_snps_escape >= 10], breaks = seq(.5, 1, .005))
hist(est_skew[num_good_snps >= 10], breaks = seq(.5, 1, .005))

par(pty = 's')
plot(est_skew, est_skew_no_escape, xlim = c(.5, 1), ylim = c(.5, 1))
abline(a = 0, b = 1, col = 'red')
```

```{r}
hist(unfold(est_skew_no_escape[num_good_snps_escape >= 10]), breaks = seq(0, 1, .005))
hist(unfold(est_skew[num_good_snps >= 10]), breaks = seq(0, 1, .005))

par(pty = 's')
plot(est_skew, est_skew_no_escape, xlim = c(.5, 1), ylim = c(.5, 1))
abline(a = 0, b = 1, col = 'red')
```



check out escape tails in the most skewed samples
```{r}

escape_genes = all_genes[adj_gene_chi_right_p_values <= .001 & num_pvalues >=gene_thresh]
length(escape_genes)
sample_index = which(est_skew_no_escape >= .75 & num_good_snps_escape >= 10)

for(i in 1:length(sample_index)){
  
  data = filt_cow_vcfs_noEscape[[sample_index[i]]]
  data = data[data$Pos %in% snp_stat_df$snp_pos[snp_stat_df$filter], ]
  ratios = data$ref_counts / (data$ref_counts + data$alt_counts)
  hist(ratios, breaks = seq(0,1,.025), main = est_skew_no_escape[sample_index[i]])
  
}


```









#############################################
#############################################


Bootstrapping

Run the bootstrapping_script.R in the command line for parallelization

nohup Rscript bootstrapping_script.R /path_to_species_filt_max_vcf /path_to_snp_stat_df /path_to_save_boot_results &


```{r}

load('/home/werner/projects/cross_species_XCI/data/species_data_analysis/bos_taurus/bootstrapping_results_3_15_23.Rdata')
length(boots)
boots[1:5]
```



```{r}
lower_CI = vector(mode = 'numeric', length = length(boots))
upper_CI = vector(mode = 'numeric', length = length(boots))

for(i in 1:length(boots)){
  
  if(length(boots[[i]])==1){lower_CI[i] = NA; upper_CI[i] = NA; next} #NA boot
  
  bootstrapped_ests = boots[[i]]$t[ ,1]  #Grab the bootstrapped estimate distribution for the ith sample
  bootstrapped_ests = bootstrapped_ests[order(bootstrapped_ests)]  #Order and get the 95th percentile CI
  lower_CI[i] = bootstrapped_ests[5]
  upper_CI[i] = bootstrapped_ests[195]
}

CI_width = upper_CI - lower_CI



length(CI_width)


```


```{r}
cow_skew_and_stats_df = data.frame(sample_id = wig_samples, 
                                   est_skew = est_skew, est_var = est_var,  #Skew estimates filtering out bad genes
                                   est_skew_total_snps = est_skew_bad_snps, est_var_total_snps = est_var_bad_snps,   #Skew estimates with all genes 
                                   est_skew_no_escape = est_skew_no_escape, est_var_no_escape = est_var_no_escape,   #Skew estimates filtering out escape
                                   num_good_snps = num_good_snps, total_snps = total_snps, num_good_snps_no_escape = num_good_snps_escape,
                                   lower_CI = lower_CI, upper_CI = upper_CI, CI_width = CI_width)

cow_skew_and_stats_df
```



```{r}

save(cow_skew_and_stats_df, file = '/home/werner/projects/cross_species_XCI/data/species_data_analysis/bos_taurus/cow_skew_and_stats_df_3_15_23.Rdata')

```

```{r}

load('/home/werner/projects/cross_species_XCI/data/species_data_analysis/bos_taurus/cow_skew_and_stats_df_3_15_23.Rdata')

```
#Save the samples that have enough X data to get autosomal data for the same samples
```{r}

writeLines(cow_skew_and_stats_df$sample_id[cow_skew_and_stats_df$num_good_snps_no_escape >= 10],
           '/home/werner/projects/cross_species_XCI/code/female_metadata/verified_X_samples/bos_taurus_verified_X_SRR.txt')

```


```{r}

quantile(cow_skew_and_stats_df$est_var_no_escape, prob = seq(0,1,.05), na.rm = T)
sample_index = cow_skew_and_stats_df$num_good_snps_no_escape >= 10
sum(sample_index)
hist(unfold(cow_skew_and_stats_df$est_skew_no_escape[sample_index]), breaks = seq(0, 1, .01))
```






check out the samples with large variance, large CI, 


```{r}
dim(cow_skew_and_stats_df)

plot(cow_skew_and_stats_df$est_var_no_escape, cow_skew_and_stats_df$CI_width)
quantile(cow_skew_and_stats_df$est_var_no_escape, probs = seq(0,1,.05), na.rm = T)
quantile(cow_skew_and_stats_df$CI_width, probs = seq(0,1,.05), na.rm = T)


```

looking at samples by their variance

```{r}
sample_index = which(cow_skew_and_stats_df$num_good_snps_no_escape >= 10 & cow_skew_and_stats_df$CI_width < .203 & cow_skew_and_stats_df$est_var_no_escape < .14 & 
                       cow_skew_and_stats_df$est_skew_no_escape > .65)
length(sample_index)
for(i in 1:length(sample_index)){
  
  data = filt_cow_vcfs_noEscape[[sample_index[i]]]
  snp_filter = data$Pos %in% snp_stat_df$snp_pos[snp_stat_df$filter]
  ref_ratios = data$ref_counts[snp_filter] / (data$ref_counts[snp_filter] + data$alt_counts[snp_filter])
  hist(ref_ratios, breaks = seq(0,1,.025), main = cow_skew_and_stats_df$est_skew_no_escape[sample_index[i]])
  
}



```

looking at samples by their confidence interval

```{r}
sample_index = which(cow_skew_and_stats_df$num_good_snps_no_escape >= 10 & cow_skew_and_stats_df$CI_width >= .174 &
                       cow_skew_and_stats_df$est_skew_no_escape > .6)
length(sample_index)
for(i in 1:length(sample_index)){
  
  data = filt_cow_vcfs_noEscape[[sample_index[i]]]
  snp_filter = data$Pos %in% snp_stat_df$snp_pos[snp_stat_df$filter]
  ref_ratios = data$ref_counts[snp_filter] / (data$ref_counts[snp_filter] + data$alt_counts[snp_filter])
  hist(ref_ratios, breaks = seq(0,1,.025))
  
}



```


```{r}

sample_index = cow_skew_and_stats_df$num_good_snps_no_escape >= 10 & cow_skew_and_stats_df$CI_width < .203 & cow_skew_and_stats_df$est_var_no_escape < .14
sum(sample_index)
hist(cow_skew_and_stats_df$est_skew_no_escape, breaks = seq(.5,1, .005))
hist(cow_skew_and_stats_df$est_skew_no_escape[sample_index], breaks = seq(.5,1, .005))

hist(unfold(cow_skew_and_stats_df$est_skew_no_escape[sample_index]), breaks = seq(0,1, .01))


```

Get a plot looking the the percent of samples each SNP shows up in the dataset, comparing across species is somewhat of a sense of how inbred the population is? 
Good question for Dan and Adam

```{r}
num_samples = length(filt_cow_vcfs)
snp_stat_df$prop_samples_present = snp_stat_df$num_samples_present / num_samples

snp_filter = snp_stat_df$filter
num_snps_present = sum(snp_filter, na.rm = T)

ggplot(snp_stat_df[snp_filter, ], aes(x = snp_pos, y = prop_samples_present)) + geom_point(alpha = .5, size = .5) + xlab('X chromosome coordinate') + 
  ylab('% of samples SNP is present and passed QC') + ggtitle(sprintf('Het SNPs (%i) present in Bos taurus bulk RNA-seq samples (%i) ',num_snps_present, num_samples))


ggplot(snp_stat_df[snp_filter, ], aes(x = snp_pos, y = mean_total_counts)) + geom_point(alpha = .5, size = .5) + xlab('X chromosome coordinate') + 
  ylab('mean total reads') + ggtitle(sprintf('Het SNPs (%i) present in Bos taurus bulk RNA-seq samples (%i) ',num_snps_present, num_samples))


ggplot(snp_stat_df[snp_filter, ], aes(x = mean_total_counts, y = prop_samples_present)) + geom_point(alpha = .5, size = .5) + xlab('mean read counts per SNP') + 
  ylab('% of samples SNP is present and passed QC') + ggtitle(sprintf('Het SNPs (%i) present in Bos taurus bulk RNA-seq samples (%i) ',num_snps_present, num_samples))



```

```{r}

cow_skew_and_stats_df

```

```{r}

p1 = ggplot(cow_skew_and_stats_df, aes(x = est_skew, y = num_good_snps)) + geom_point(alpha = .5, size = .5) + xlab('Estimated XCI skew') + ylab("Number of SNPs skew estimate is derived from") + ggtitle('Bos taurus samples') + xlim(.5,1)


ggMarginal(p1, type = 'histogram', margin = 'x', breaks = seq(.5,1, .005))

```

```{r}


hist(cow_skew_and_stats_df$CI_width, breaks = 32)

plot(cow_skew_and_stats_df$est_skew, cow_skew_and_stats_df$CI_width)
plot(cow_skew_and_stats_df$num_good_snps, cow_skew_and_stats_df$CI_width)
```




 


























